<div class="job-detail-page">
  <app-loading-state *ngIf="loading" message="Loading job details..."></app-loading-state>

  <app-empty-state *ngIf="!loading && !job"
    icon="error_outline"
    title="Job Not Found"
    description="This job posting may have been removed or doesn't exist.">
    <button class="btn-gradient" (click)="goBack()">Browse Jobs</button>
  </app-empty-state>

  <div class="job-content" *ngIf="!loading && job">

    <div class="success-banner" *ngIf="paymentSuccess">
      <mat-icon>check_circle</mat-icon>
      <span>Payment successful! The job is now in progress.</span>
    </div>

    <button class="back-btn" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Jobs
    </button>

    <div class="content-grid">

      <main class="main-section">

        <div class="job-header">
          <div class="header-top">
            <span class="job-category" *ngIf="category">{{ category.name }}</span>
            <span class="job-status" [class]="fmt.getStatusClass(job.status)">{{ job.status }}</span>
            <span class="remote-badge" *ngIf="job.is_remote">Remote</span>
          </div>
          <h1 class="job-title">{{ job.title }}</h1>
          <div class="job-meta">
            <span class="meta-item" *ngIf="job.budget">
              {{ fmt.formatBudget(job.budget) }}
            </span>
            <span class="meta-item" *ngIf="job.deadline">
              <mat-icon>event</mat-icon>
              Due {{ job.deadline | date:'MMM d, y' }}
            </span>
            <span class="meta-item" *ngIf="job.location">
              <mat-icon>location_on</mat-icon>
              {{ job.location }}
            </span>
          </div>
        </div>

        <div class="job-details-grid" *ngIf="job.experience_level || job.job_type || job.duration_estimate">
          <div class="detail-item" *ngIf="job.experience_level">
            <span class="detail-label">Experience Level</span>
            <span class="detail-value">{{ fmt.getExperienceLabel(job.experience_level) }}</span>
          </div>
          <div class="detail-item" *ngIf="job.job_type">
            <span class="detail-label">Project Type</span>
            <span class="detail-value">{{ fmt.getJobTypeLabel(job.job_type) }}</span>
          </div>
          <div class="detail-item" *ngIf="job.duration_estimate">
            <span class="detail-label">Estimated Duration</span>
            <span class="detail-value">{{ fmt.getDurationLabel(job.duration_estimate) }}</span>
          </div>
        </div>

        <div class="job-skills" *ngIf="jobSkillNames.length > 0">
          <h2>Required Skills</h2>
          <div class="skills-list">
            <span class="skill-tag-pill" *ngFor="let skillName of jobSkillNames">{{ skillName }}</span>
          </div>
        </div>

        <div class="job-description">
          <h2>Job Description</h2>
          <p>{{ job.description }}</p>
        </div>

        <div class="category-info" *ngIf="category">
          <h2>Category</h2>
          <div class="category-card">
            <h3>{{ category.name }}</h3>
            <p *ngIf="category.description">{{ category.description }}</p>
          </div>
        </div>
      </main>

      <aside class="sidebar">

        <div class="employer-card">
          <h3>About the Client</h3>
          <div class="employer-info">
            <div class="employer-avatar">
              <span class="avatar-initials">{{ getEmployerInitials() }}</span>
            </div>
            <div class="employer-details">
              <p class="employer-name">{{ getEmployerName() }}</p>
              <p class="employer-label">Employer</p>
            </div>
          </div>
        </div>

        <div class="apply-card">

          <div class="applied-state" *ngIf="applied">
            <div class="success-icon">
              <mat-icon>check_circle</mat-icon>
            </div>
            <h3>Application Submitted!</h3>
            <p>Your proposal has been sent to the client. You'll be notified when they respond.</p>
          </div>

          <div class="apply-form" *ngIf="!applied && isLoggedIn && isFreelancer && job.status === 'Open'">
            <h3>Submit a Proposal</h3>

            <div class="form-group-dark">
              <label for="bidAmount">Your Bid ($)</label>
              <input
                type="number"
                id="bidAmount"
                class="form-input-dark"
                [(ngModel)]="bidAmount"
                placeholder="Enter your bid amount"
                min="1"
              />
            </div>

            <div class="form-group-dark">
              <label for="proposal">Cover Letter</label>
              <textarea
                id="proposal"
                class="form-textarea-dark"
                [(ngModel)]="proposalText"
                placeholder="Explain why you're the best fit for this job..."
                rows="6"
              ></textarea>
            </div>

            <button
              class="btn-gradient btn-block"
              (click)="apply()"
              [disabled]="applying || !bidAmount || !proposalText.trim()">
              <span *ngIf="!applying">Submit Proposal</span>
              <span *ngIf="applying">Submitting...</span>
            </button>
          </div>

          <div class="closed-state" *ngIf="!applied && job.status !== 'Open'">
            <h3>Job Not Available</h3>
            <p>This job is no longer accepting applications.</p>
            <button class="btn-dark-secondary" (click)="goBack()">Browse Other Jobs</button>
          </div>

          <div class="employer-view" *ngIf="!applied && isLoggedIn && isOwner">
            <h3>Manage Your Listing</h3>
            <p class="proposals-count">{{ applications.length }} proposal(s) received</p>
          </div>

          <div class="employer-view" *ngIf="!applied && isLoggedIn && !isFreelancer && !isOwner && job.status === 'Open'">
            <h3>Employer Account</h3>
            <p>Only freelancers can submit proposals to jobs.</p>
          </div>

          <div class="guest-view" *ngIf="!isLoggedIn && job.status === 'Open'">
            <h3>Want to Apply?</h3>
            <p>Create a free account to submit proposals and start working on projects.</p>
            <button class="btn-gradient btn-block" (click)="showAuthModal = true">Sign Up to Apply</button>
            <p class="login-link">Already have an account? <a routerLink="/login">Log in</a></p>
          </div>
        </div>

        <div class="proposals-card" *ngIf="isOwner && applications.length > 0">
          <h3>Proposals ({{ applications.length }})</h3>

          <div class="proposals-list">
            <div class="proposal-item" *ngFor="let app of applications" [class]="'status-' + app.status.toLowerCase()">
              <div class="proposal-header">
                <div class="applicant-info">
                  <div class="applicant-avatar">
                    <img *ngIf="app.photo_url" [src]="app.photo_url" [alt]="getApplicantName(app)" />
                    <span *ngIf="!app.photo_url" class="avatar-initials">{{ getApplicantInitials(app) }}</span>
                  </div>
                  <div class="applicant-details">
                    <h4 class="applicant-name">{{ getApplicantName(app) }}</h4>
                    <p class="applicant-headline" *ngIf="app.headline">{{ app.headline }}</p>
                    <p class="applicant-rate" *ngIf="app.hourly_rate">${{ app.hourly_rate }}/hr</p>
                  </div>
                </div>
                <div class="proposal-bid">
                  <span class="bid-amount">${{ app.bid_amount }}</span>
                  <span class="bid-label">Proposed</span>
                </div>
              </div>

              <div class="proposal-text" *ngIf="app.proposal_text">
                <p>{{ app.proposal_text }}</p>
              </div>

              <div class="proposal-footer">
                <span class="proposal-status" [class]="'status-' + app.status.toLowerCase()">
                  {{ app.status }}
                </span>

                <div class="proposal-actions" *ngIf="app.status === 'Pending'">
                  <button class="btn-accept" (click)="acceptApplication(app.application_id)">
                    Accept
                  </button>
                  <button class="btn-reject" (click)="rejectApplication(app.application_id)">
                    Reject
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="no-proposals-card" *ngIf="isOwner && applications.length === 0 && !loadingApplications">
          <h3>No Proposals Yet</h3>
          <p>Your job is visible to freelancers. Proposals will appear here when freelancers apply.</p>
        </div>
      </aside>
    </div>
  </div>
</div>
