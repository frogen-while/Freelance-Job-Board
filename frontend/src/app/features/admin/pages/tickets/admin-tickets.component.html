<div class="admin-tickets">
  <header class="page-header">
    <h1 class="page-title">Support Tickets</h1>
    <p class="page-subtitle">Manage and respond to support requests</p>
  </header>

  <!-- Messages -->
  <div class="success-message" *ngIf="successMessage">
    <mat-icon>check_circle</mat-icon>
    <span>{{ successMessage }}</span>
  </div>
  
  <div class="error-message" *ngIf="errorMessage">
    <mat-icon>error_outline</mat-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
        <option value="">All Status</option>
        <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
      </select>
    </div>
  </div>

  <!-- Tickets Table -->
  <div class="table-container" *ngIf="!loading">
    <table class="data-table">
      <thead>
        <tr>
          <th>Subject</th>
          <th>User ID</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of filteredTickets">
          <td>
            <button class="subject-link" (click)="openDetailModal(ticket)">
              {{ ticket.subject }}
            </button>
          </td>
          <td class="user-cell">#{{ ticket.user_id }}</td>
          <td>
            <span class="status-badge" [attr.data-status]="ticket.status">{{ ticket.status }}</span>
          </td>
          <td class="date-cell">{{ dateService.format(ticket.created_at, 'short') }}</td>
          <td class="actions-cell">
            <button class="action-btn" (click)="openDetailModal(ticket)" title="View details">
              <mat-icon>visibility</mat-icon>
            </button>
            <button class="action-btn" (click)="openMessageModal(ticket)" title="Send message">
              <mat-icon>message</mat-icon>
            </button>
            <select class="action-select" 
                    [value]="ticket.status"
                    (change)="updateStatus(ticket, $any($event.target).value); $any($event.target).value = ticket.status">
              <option value="" disabled>Change status...</option>
              <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
            </select>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div class="empty-state-dark" *ngIf="filteredTickets.length === 0">
      <mat-icon>inbox</mat-icon>
      <p>No tickets found</p>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state-dark" *ngIf="loading">
    <div class="spinner"></div>
    <span>Loading tickets...</span>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2>{{ selectedTicket?.subject }}</h2>
          <span class="ticket-id">#{{ selectedTicket?.ticket_id }}</span>
        </div>
        <button class="close-btn" (click)="closeDetailModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="selectedTicket">
        <div class="ticket-info">
          <div class="info-row">
            <span class="info-label">User ID:</span>
            <span>#{{ selectedTicket.user_id }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Email:</span>
            <span>{{ selectedTicket.user_email }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="status-badge" [attr.data-status]="selectedTicket.status">{{ selectedTicket.status }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Created:</span>
            <span>{{ dateService.format(selectedTicket.created_at, 'short') }}</span>
          </div>
        </div>
        
        <div class="ticket-message">
          <h4>Message</h4>
          <p>{{ selectedTicket.message }}</p>
        </div>
        
        <div class="ticket-notes">
          <h4>Conversation</h4>
          
          <div class="notes-list" *ngIf="!loadingNotes">
            <div class="note-item" *ngFor="let note of ticketNotes">
              <div class="note-header">
                <span class="note-author support-author" *ngIf="note.is_internal">
                  <mat-icon>support_agent</mat-icon> Support
                </span>
                <span class="note-author" *ngIf="!note.is_internal">User #{{ note.user_id }}</span>
                <span class="note-date">{{ dateService.format(note.created_at, 'short') }}</span>
              </div>
              <p class="note-content">{{ note.content }}</p>
            </div>
            
            <div class="empty-notes" *ngIf="ticketNotes.length === 0">
              No messages yet
            </div>
          </div>
          
          <div class="loading-notes" *ngIf="loadingNotes">
            <div class="spinner small"></div>
          </div>
          
          <div class="add-note">
            <textarea 
              [(ngModel)]="newNote" 
              placeholder="Reply to user..."
              rows="2"></textarea>
            <button class="btn-primary" (click)="addNote()" [disabled]="!newNote.trim()">
              <mat-icon>send</mat-icon> Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Modal -->
  <div class="modal-overlay" *ngIf="showMessageModal" (click)="closeMessageModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Send Message</h2>
        <button class="close-btn" (click)="closeMessageModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="info-row">
          <span class="info-label">To:</span>
          <span>User #{{ messageTicket?.user_id }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Regarding:</span>
          <span>{{ messageTicket?.subject }}</span>
        </div>
        
        <div class="message-input">
          <textarea 
            [(ngModel)]="messageText" 
            placeholder="Type your message..."
            rows="4"></textarea>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-outline" (click)="closeMessageModal()">Cancel</button>
        <button class="btn-primary" (click)="sendMessage()" [disabled]="!messageText.trim()">
          <mat-icon>send</mat-icon> Send Message
        </button>
      </div>
    </div>
  </div>
</div>
