<div class="admin-tickets">
  <header class="page-header">
    <h1 class="page-title">Support Tickets</h1>
    <p class="page-subtitle">Manage support requests</p>
  </header>

  <app-alert-message [message]="successMessage" type="success"></app-alert-message>
  <app-alert-message [message]="errorMessage" type="error"></app-alert-message>

  <div class="filters-bar">
    <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
      <option value="">All Status</option>
      <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
    </select>
  </div>

  <div class="table-container" *ngIf="!loading">
    <table class="data-table">
      <thead>
        <tr>
          <th>Subject</th>
          <th>User ID</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of filteredTickets">
          <td>
            <button class="subject-link" (click)="openDetailModal(ticket)">
              {{ ticket.subject }}
            </button>
          </td>
          <td class="user-cell">#{{ ticket.user_id }}</td>
          <td>
            <span class="status-badge" [attr.data-status]="ticket.status">{{ ticket.status }}</span>
          </td>
          <td class="date-cell">{{ dateService.format(ticket.created_at, 'short') }}</td>
          <td class="actions-cell">
            <button class="action-btn" (click)="openDetailModal(ticket)" title="View details">
              <mat-icon>visibility</mat-icon>
            </button>
            <select class="action-select"
                    *ngIf="canChangeStatus && canChangeStatusFor(ticket)"
                    [value]="ticket.status"
                    (change)="updateStatus(ticket, $any($event.target).value); $any($event.target).value = ticket.status">
              <option value="" disabled>Change status...</option>
              <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
            </select>
            <div class="assign-controls" *ngIf="canAssignToManager">
              <select class="action-select" [(ngModel)]="selectedManagerIds[ticket.ticket_id]" [disabled]="managers.length === 0">
                <option [ngValue]="null">Select manager...</option>
                <option *ngFor="let manager of managers" [ngValue]="manager.user_id">
                  {{ manager.first_name }} {{ manager.last_name }} (#{{ manager.user_id }})
                </option>
              </select>
              <button class="action-btn" (click)="sendToManager(ticket)" [disabled]="managers.length === 0" title="Send to manager">
                <mat-icon>forward_to_inbox</mat-icon>
              </button>
              <span class="muted" *ngIf="managers.length === 0">No managers available</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <app-empty-state *ngIf="filteredTickets.length === 0" icon="inbox" title="No tickets found"></app-empty-state>
  </div>

  <app-loading-state *ngIf="loading" message="Loading tickets..."></app-loading-state>

  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2>{{ selectedTicket?.subject }}</h2>
          <span class="ticket-id">#{{ selectedTicket?.ticket_id }}</span>
        </div>
        <button class="close-btn" (click)="closeDetailModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body" *ngIf="selectedTicket">
        <div class="ticket-info">
          <div class="info-row">
            <span class="info-label">User ID:</span>
            <span>#{{ selectedTicket.user_id }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Email:</span>
            <span>{{ selectedTicket.user_email }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="status-badge" [attr.data-status]="selectedTicket.status">{{ selectedTicket.status }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Created:</span>
            <span>{{ dateService.format(selectedTicket.created_at, 'short') }}</span>
          </div>
        </div>

        <div class="ticket-message">
          <h4>Message</h4>
          <p>{{ selectedTicket.message }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
