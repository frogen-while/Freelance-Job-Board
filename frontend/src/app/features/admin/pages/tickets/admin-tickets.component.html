<div class="admin-tickets">
  <header class="page-header">
    <h1 class="page-title">Support Tickets</h1>
    <p class="page-subtitle">Manage and respond to support requests</p>
  </header>

  <!-- Messages -->
  <div class="success-message" *ngIf="successMessage">
    <mat-icon>check_circle</mat-icon>
    <span>{{ successMessage }}</span>
  </div>
  
  <div class="error-message" *ngIf="errorMessage">
    <mat-icon>error_outline</mat-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
        <option value="">All Status</option>
        <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
      </select>
      
      <select [(ngModel)]="priorityFilter" (change)="onFilterChange()">
        <option value="">All Priority</option>
        <option *ngFor="let priority of priorities" [value]="priority">{{ priority | titlecase }}</option>
      </select>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="bulk-actions" *ngIf="selectedTickets.size > 0">
    <span class="selected-count">{{ selectedTickets.size }} selected</span>
    <div class="bulk-buttons">
      <button class="btn-secondary" (click)="bulkUpdateStatus('In Progress')">
        Mark In Progress
      </button>
      <button class="btn-success" (click)="bulkUpdateStatus('Resolved')">
        Mark Resolved
      </button>
      <button class="btn-outline" (click)="bulkUpdateStatus('Closed')">
        Close
      </button>
    </div>
  </div>

  <!-- Tickets Table -->
  <div class="table-container" *ngIf="!loading">
    <table class="data-table">
      <thead>
        <tr>
          <th class="checkbox-col">
            <input type="checkbox" 
                   [checked]="selectedTickets.size === filteredTickets.length && filteredTickets.length > 0"
                   (change)="selectAll()">
          </th>
          <th>Subject</th>
          <th>User</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of filteredTickets">
          <td class="checkbox-col">
            <input type="checkbox" 
                   [checked]="isSelected(ticket.ticket_id)"
                   (change)="toggleTicketSelection(ticket.ticket_id)">
          </td>
          <td>
            <button class="subject-link" (click)="openDetailModal(ticket)">
              {{ ticket.subject }}
            </button>
          </td>
          <td class="user-cell">
            {{ ticket.user_name || 'User #' + ticket.user_id }}
          </td>
          <td>
            <select class="priority-select" 
                    [value]="ticket.priority || 'medium'"
                    [attr.data-priority]="ticket.priority || 'medium'"
                    (change)="updatePriority(ticket, $any($event.target).value)">
              <option *ngFor="let p of priorities" [value]="p">{{ p | titlecase }}</option>
            </select>
          </td>
          <td>
            <select class="status-select" 
                    [value]="ticket.status"
                    [attr.data-status]="ticket.status"
                    (change)="updateStatus(ticket, $any($event.target).value)">
              <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
            </select>
          </td>
          <td>
            <select class="assign-select" 
                    [value]="ticket.assigned_to || ''"
                    (change)="assignTicket(ticket, +$any($event.target).value)">
              <option value="">Unassigned</option>
              <option *ngFor="let staff of supportStaff" [value]="staff.user_id">
                {{ staff.first_name }} {{ staff.last_name }}
              </option>
            </select>
          </td>
          <td class="date-cell">{{ formatDate(ticket.created_at) }}</td>
          <td class="actions-cell">
            <button class="action-btn" (click)="openDetailModal(ticket)" title="View details">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div class="empty-state" *ngIf="filteredTickets.length === 0">
      <mat-icon>inbox</mat-icon>
      <p>No tickets found</p>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <span>Loading tickets...</span>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-group">
          <h2>{{ selectedTicket?.subject }}</h2>
          <span class="ticket-id">#{{ selectedTicket?.ticket_id }}</span>
        </div>
        <button class="close-btn" (click)="closeDetailModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="selectedTicket">
        <div class="ticket-info">
          <div class="info-row">
            <span class="info-label">From:</span>
            <span>{{ selectedTicket.user_name || 'User #' + selectedTicket.user_id }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Email:</span>
            <span>{{ selectedTicket.user_email }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Created:</span>
            <span>{{ formatDate(selectedTicket.created_at) }}</span>
          </div>
        </div>
        
        <div class="ticket-message">
          <h4>Message</h4>
          <p>{{ selectedTicket.message }}</p>
        </div>
        
        <div class="ticket-notes">
          <h4>Internal Notes</h4>
          
          <div class="notes-list" *ngIf="!loadingNotes">
            <div class="note-item" *ngFor="let note of ticketNotes">
              <div class="note-header">
                <span class="note-author">{{ note.user_name || 'Staff' }}</span>
                <span class="note-date">{{ formatDate(note.created_at) }}</span>
              </div>
              <p class="note-content">{{ note.content }}</p>
            </div>
            
            <div class="empty-notes" *ngIf="ticketNotes.length === 0">
              No notes yet
            </div>
          </div>
          
          <div class="loading-notes" *ngIf="loadingNotes">
            <div class="spinner small"></div>
          </div>
          
          <div class="add-note">
            <textarea 
              [(ngModel)]="newNote" 
              placeholder="Add internal note..."
              rows="2"></textarea>
            <button class="btn-primary" (click)="addNote()" [disabled]="!newNote.trim()">
              <mat-icon>add</mat-icon> Add Note
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
